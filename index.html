<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qur'on Zukkolar Imtihoni | Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- 1. GLOBAL VARIABLES & THEME --- */
        :root {
            --primary: #064e3b; /* To'q Zumrad */
            --primary-light: #10b981;
            --accent: #d97706; /* Oltin */
            --bg-light: #f3f4f6;
            --surface-light: #ffffff;
            --text-light: #1f2937;
            
            --bg-dark: #111827;
            --surface-dark: #1f2937;
            --text-dark: #f9fafb;

            --success: #059669;
            --error: #dc2626;
            --radius: 16px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark Mode Override */
        [data-theme="dark"] {
            --bg-light: var(--bg-dark);
            --surface-light: var(--surface-dark);
            --text-light: var(--text-dark);
            --primary: #34d399; /* Yorqinroq yashil */
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- 2. UTILITY CLASSES --- */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .hidden { display: none !important; }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 3. COMPONENTS --- */
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 28px;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn:active { transform: scale(0.96); }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #047857 100%);
            color: white;
        }
        [data-theme="dark"] .btn-primary { color: #000; }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        [data-theme="dark"] .btn-outline:hover { color: #000; }

        /* Card */
        .card {
            background: var(--surface-light);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        /* Header & Nav */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 20px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-light);
        }

        /* --- 4. SECTIONS --- */

        /* Home */
        .hero-title {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        .hero-desc {
            font-size: 1.1rem;
            opacity: 0.8;
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .high-score-badge {
            background: var(--accent);
            color: white;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: inline-block;
        }

        /* Selection Grid */
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin: 30px 0;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .mode-grid::-webkit-scrollbar { width: 6px; }
        .mode-grid::-webkit-scrollbar-thumb { background-color: var(--primary); border-radius: 10px; }

        .juz-btn {
            background: var(--surface-light);
            border: 1px solid rgba(0,0,0,0.1);
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: var(--text-light);
        }
        .juz-btn:hover {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.1);
            transform: translateY(-2px);
        }

        /* Quiz Interface */
        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.5s ease;
        }

        .quran-text {
            font-family: 'Amiri', serif;
            font-size: 2.2rem;
            line-height: 2.2;
            color: var(--text-light);
            margin: 30px 0;
            direction: rtl;
        }
        
        .question-meta {
            font-size: 0.9rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .options-container {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .option-card {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            text-align: right;
            font-family: 'Amiri', serif;
            font-size: 1.4rem;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .option-card:hover { border-color: var(--primary); }
        
        .option-card.correct {
            background-color: rgba(5, 150, 105, 0.2);
            border-color: var(--success);
            color: var(--success);
        }
        
        .option-card.wrong {
            background-color: rgba(220, 38, 38, 0.2);
            border-color: var(--error);
            color: var(--error);
        }

        /* Hikmat Box */
        .hikmat-toast {
            margin-top: 25px;
            padding: 15px;
            border-left: 4px solid var(--accent);
            background: rgba(217, 119, 6, 0.1);
            text-align: left;
            font-style: italic;
            border-radius: 0 8px 8px 0;
            display: none;
            animation: fadeIn 0.5s;
        }

        /* Results */
        .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0deg, rgba(0,0,0,0.1) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            position: relative;
        }
        .score-circle::before {
            content: "";
            position: absolute;
            width: 150px;
            height: 150px;
            background: var(--surface-light);
            border-radius: 50%;
        }
        .score-number {
            position: relative;
            z-index: 2;
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            font-size: 0.85rem;
            opacity: 0.6;
        }

        /* Mobile Optimization */
        @media (max-width: 600px) {
            .hero-title { font-size: 1.8rem; }
            .quran-text { font-size: 1.6rem; }
            .option-card { font-size: 1.2rem; padding: 15px; }
            .card { padding: 20px; }
        }
    </style>
</head>
<body>

    <div class="top-nav container">
        <div class="logo">
            <span>Û</span> Qur'on Zukkolar
        </div>
        <button class="theme-toggle" id="theme-btn" onclick="app.toggleTheme()">ğŸŒ™</button>
    </div>

    <main id="home-section" class="container fade-in">
        <div class="card">
            <span class="high-score-badge" id="high-score-display">Eng yaxshi natija: 0%</span>
            <h1 class="hero-title">Aql va Qalb Imtihoni</h1>
            <p class="hero-desc">Qur'oni Karimni yodlash darajangizni aniqlovchi, zukkolik va diqqatni talab qiluvchi intellektual platforma.</p>
            
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="app.showModeSelect()">Boshlash</button>
                <button class="btn btn-outline" onclick="alert('Tez orada: Musobaqa rejimi')">Reyting</button>
            </div>
            
            <div style="margin-top: 30px; font-size: 0.9rem; color: #888;">
                <p>âœ“ Audio yo'q &nbsp; âœ“ Rasm yo'q &nbsp; âœ“ Faqat ilm</p>
            </div>
        </div>
    </main>

    <section id="mode-section" class="container hidden fade-in">
        <div class="card">
            <h2>Imtihon turini tanlang</h2>
            
            <div style="display: flex; justify-content: center; gap: 10px; margin: 20px 0;">
                <button class="btn btn-outline" id="diff-easy" onclick="app.setDifficulty('easy')">Oson</button>
                <button class="btn btn-outline" id="diff-medium" onclick="app.setDifficulty('medium')">O'rta</button>
                <button class="btn btn-outline" id="diff-hard" onclick="app.setDifficulty('hard')">Qiyin</button>
            </div>

            <p style="font-size: 0.9rem; opacity: 0.7;">30 poradan birini yoki umumiyni tanlang:</p>

            <div class="mode-grid" id="juz-container">
                </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="app.startFullTest()">
                Butun Qur'on (Tasodifiy)
            </button>
            <br><br>
            <button class="btn btn-outline" style="border:none;" onclick="app.goHome()">â† Orqaga</button>
        </div>
    </section>

    <section id="quiz-section" class="container hidden">
        <div class="card">
            <div class="progress-container">
                <div class="progress-bar" id="quiz-progress"></div>
            </div>
            
            <div class="question-meta">
                <span id="q-counter">1 / 10</span> â€¢ <span id="q-diff-label">Oson</span>
            </div>

            <h3 id="q-instruction" style="margin-bottom: 10px;">Savol matni...</h3>

            <div class="quran-text" id="q-ayah-display">
                </div>

            <div class="options-container" id="options-list">
                </div>

            <div id="hikmat-box" class="hikmat-toast">
                <strong style="color:var(--primary)">Hikmat:</strong> <span id="hikmat-text"></span>
            </div>

            <div style="margin-top: 30px; display: flex; justify-content: space-between;">
                <button class="btn btn-outline" onclick="app.confirmExit()">Chiqish</button>
                <button id="next-btn" class="btn btn-primary hidden" onclick="app.nextQuestion()">Keyingi â†’</button>
            </div>
        </div>
    </section>

    <section id="result-section" class="container hidden fade-in">
        <div class="card">
            <h2>Imtihon Natijasi</h2>
            <br>
            <div class="score-circle" id="result-circle">
                <div class="score-number" id="result-percent">0%</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div style="background: rgba(5, 150, 105, 0.1); padding: 15px; border-radius: 12px;">
                    <h3 style="color: var(--success)" id="res-correct">0</h3>
                    <small>To'g'ri</small>
                </div>
                <div style="background: rgba(220, 38, 38, 0.1); padding: 15px; border-radius: 12px;">
                    <h3 style="color: var(--error)" id="res-wrong">0</h3>
                    <small>Xato</small>
                </div>
            </div>

            <div id="feedback-text" style="margin-bottom: 30px; font-weight: 600;"></div>

            <button class="btn btn-primary" onclick="app.showModeSelect()">Qayta Topshirish</button>
            <button class="btn btn-outline" style="margin-top: 10px; border:none;" onclick="app.goHome()">Bosh Sahifa</button>
        </div>
    </section>

    <footer>
        Â© 2025 Muhammad Daler | Qur'on xizmatida
    </footer>

    <script>
        // --- MA'LUMOTLAR BAZASI (Mock Data) ---
        // Haqiqiy loyihada bu yerda minglab savollar bo'ladi.
        // Hozir namuna sifatida "High IQ" savollar kiritilgan.
        const DB = [
            // JUZ 30
            {
                id: 1, juz: 30, diff: 'easy',
                q: "An-Naba surasining ushbu oyatini davom ettiring:",
                ayah: "Ø¹ÙÙ…ÙÙ‘ ÙŠÙØªÙØ³ÙØ¢Ø¡ÙÙ„ÙÙˆÙ†Ù",
                options: ["Ø¹ÙÙ†Ù Ù±Ù„Ù†ÙÙ‘Ø¨ÙØ¥Ù Ù±Ù„Û¡Ø¹ÙØ¸ÙÙŠÙ…Ù", "ÙƒÙÙ„ÙÙ‘Ø§ Ø³ÙÙŠÙØ¹Û¡Ù„ÙÙ…ÙÙˆÙ†Ù", "Ø£ÙÙ„ÙÙ…Û¡ Ù†ÙØ¬Û¡Ø¹ÙÙ„Ù Ù±Ù„Û¡Ø£ÙØ±Û¡Ø¶Ù Ù…ÙÙ‡ÙÙ°Ø¯Ù—Ø§", "ÙˆÙØ®ÙÙ„ÙÙ‚Û¡Ù†ÙÙ°ÙƒÙÙ…Û¡ Ø£ÙØ²Û¡ÙˆÙÙ°Ø¬Ù—Ø§"],
                correct: 0,
                hikmat: "Kim ilm yo'liga yursa, Alloh unga jannat yo'lini oson qiladi."
            },
            {
                id: 2, juz: 30, diff: 'medium',
                q: "Abasa surasi: So'zlar ketma-ketligini to'g'ri toping:",
                ayah: "(Meva) -> (O't-o'lan) -> (Zaytun)",
                options: ["ÙˆÙÙÙÙ°ÙƒÙÙ‡ÙØ©Ù— ÙˆÙØ£ÙØ¨Ù‘Ù—Ø§", "ÙˆÙØ²ÙÙŠÛ¡ØªÙÙˆÙ†Ù—Ø§ ÙˆÙÙ†ÙØ®Û¡Ù„Ù—Ø§", "ÙˆÙØ¹ÙÙ†ÙØ¨Ù—Ø§ ÙˆÙÙ‚ÙØ¶Û¡Ø¨Ù—Ø§", "Ø­ÙØ¯ÙØ¢Ø¦ÙÙ‚Ù ØºÙÙ„Û¡Ø¨Ù—Ø§"],
                correct: 0, 
                hikmat: "Qur'on qalbning shifosidir."
            },
            {
                id: 3, juz: 30, diff: 'hard',
                q: "Mutashabih (o'xshash) oyatni farqlang: Fajr surasi",
                ayah: "ÙˆÙØ¬ÙØ¢Ø¡Ù Ø±ÙØ¨ÙÙ‘ÙƒÙ ...",
                options: ["ÙˆÙÙ±Ù„Û¡Ù…ÙÙ„ÙÙƒÙ ØµÙÙÙ‘Ù—Ø§ ØµÙÙÙ‘Ù—Ø§", "ÙˆÙÙ±Ù„Û¡Ù…ÙÙ„ÙÙƒÙ ØµÙÙÙ‹Ù‘Ø§ Ù„ÙÙ‘Ø§ ÙŠÙØªÙÙƒÙÙ„ÙÙ‘Ù…ÙÙˆÙ†Ù", "ÙŠÙÙˆÛ¡Ù…ÙØ¦ÙØ°Ù ÙŠÙØªÙØ°ÙÙƒÙÙ‘Ø±Ù", "ÙÙÙŠÙÙˆÛ¡Ù…ÙØ¦ÙØ°Ù– Ù„ÙÙ‘Ø§ ÙŠÙØ¹ÙØ°ÙÙ‘Ø¨Ù"],
                correct: 0,
                hikmat: "Hifz - bu shunchaki yodlash emas, amal qilishdir."
            },
            // JUZ 29
            {
                id: 4, juz: 29, diff: 'medium',
                q: "Mulk surasi: Ushbu oyatni yakunlang:",
                ayah: "Ù±Ù„ÙÙ‘Ø°ÙÙŠ Ø®ÙÙ„ÙÙ‚Ù Ù±Ù„Û¡Ù…ÙÙˆÛ¡ØªÙ ÙˆÙÙ±Ù„Û¡Ø­ÙÙŠÙÙˆÙ°Ø©Ù Ù„ÙÙŠÙØ¨Û¡Ù„ÙÙˆÙÙƒÙÙ…Û¡...",
                options: ["Ø£ÙÙŠÙÙ‘ÙƒÙÙ…Û¡ Ø£ÙØ­Û¡Ø³ÙÙ†Ù Ø¹ÙÙ…ÙÙ„Ù—Ø§Ûš", "Ø£ÙÙŠÙÙ‘ÙƒÙÙ…Û¡ Ø£ÙÙ‚Ù’ÙˆÙÙ…Ù Ù‚ÙÙŠÙ„Ù‹Ø§", "Ù…ÙØ§ Ù„ÙÙƒÙÙ…Û¡ ÙƒÙÙŠÛ¡ÙÙ ØªÙØ­Û¡ÙƒÙÙ…ÙÙˆÙ†Ù", "Ø®ÙÙ°Ø´ÙØ¹ÙØ©Ù‹ Ø£ÙØ¨Û¡ØµÙÙ°Ø±ÙÙ‡ÙÙ…Û¡"],
                correct: 0,
                hikmat: "Amallarning eng yaxshisi davomli bo'lganidir."
            },
            {
                id: 5, juz: 29, diff: 'hard',
                q: "Qalam surasi: Bu oyatdan OLDIN qaysi oyat kelgan?",
                ayah: "... Ù…ÙØ§ Ù„ÙÙƒÙÙ…Û¡ ÙƒÙÙŠÛ¡ÙÙ ØªÙØ­Û¡ÙƒÙÙ…ÙÙˆÙ†Ù",
                options: ["Ø£ÙÙ…Û¡ Ù†ÙØ¬Û¡Ø¹ÙÙ„Ù Ù±Ù„Û¡Ù…ÙØªÙÙ‘Ù‚ÙÙŠÙ†Ù ÙƒÙÙ±Ù„Û¡ÙÙØ¬ÙÙ‘Ø§Ø±Ù", "Ø£ÙÙ…Û¡ Ù„ÙÙƒÙÙ…Û¡ ÙƒÙØªÙÙ°Ø¨Ù ÙÙÙŠÙ‡Ù ØªÙØ¯Û¡Ø±ÙØ³ÙÙˆÙ†Ù", "Ø³ÙÙ„Û¡Ù‡ÙÙ…Û¡ Ø£ÙÙŠÙÙ‘Ù‡ÙÙ… Ø¨ÙØ°ÙÙ°Ù„ÙÙƒÙ Ø²ÙØ¹ÙÙŠÙ…", "Ù†ÙÙˆÙ†Ûš ÙˆÙÙ±Ù„Û¡Ù‚ÙÙ„ÙÙ…Ù"],
                correct: 0,
                hikmat: "Adolat â€” taqyoga eng yaqin ishdir."
            },
            // JUZ 1
            {
                id: 6, juz: 1, diff: 'easy',
                q: "Baqara surasi, 2-oyat boshi:",
                ayah: "Ø°ÙÙ°Ù„ÙÙƒÙ Ù±Ù„Û¡ÙƒÙØªÙÙ°Ø¨Ù...",
                options: ["Ù„ÙØ§ Ø±ÙÙŠÛ¡Ø¨ÙÛ› ÙÙÙŠÙ‡ÙÛ›", "Ù‡ÙØ¯Ù—Ù‰ Ù„ÙÙ‘Ù„Û¡Ù…ÙØªÙÙ‘Ù‚ÙÙŠÙ†Ù", "Ø§Ù„Ù“Ù…Ù“", "ÙŠÙØ¤Û¡Ù…ÙÙ†ÙÙˆÙ†Ù Ø¨ÙÙ±Ù„Û¡ØºÙÙŠÛ¡Ø¨Ù"],
                correct: 0,
                hikmat: "Shubhasiz, bu Kitobda hech qanday shak-shubha yo'q."
            },
            {
                id: 7, juz: 1, diff: 'hard',
                q: "Baqara surasi: Oyat oxirini toping (Mutashabih)",
                ayah: "Ø®ÙØªÙÙ…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ø¹ÙÙ„ÙÙ‰Ù° Ù‚ÙÙ„ÙÙˆØ¨ÙÙ‡ÙÙ…Û¡ ...",
                options: ["ÙˆÙÙ„ÙÙ‡ÙÙ…Û¡ Ø¹ÙØ°ÙØ§Ø¨ÙŒ Ø¹ÙØ¸ÙÙŠÙ…Ù", "ÙˆÙÙ„ÙÙ‡ÙÙ…Û¡ Ø¹ÙØ°ÙØ§Ø¨ÙŒ Ø£ÙÙ„ÙÙŠÙ…Ù", "ÙˆÙÙ„ÙÙ‡ÙÙ…Û¡ Ø¹ÙØ°ÙØ§Ø¨ÙŒ Ù…ÙÙ‘Ù‡ÙÙŠÙ†Ù", "Ø¨ÙÙ…ÙØ§ ÙƒÙØ§Ù†ÙÙˆØ§Ù’ ÙŠÙÙƒÛ¡Ø°ÙØ¨ÙÙˆÙ†Ù"],
                correct: 0, // 2:7 ends with Azabun 'Azim
                hikmat: "Alloh qalblarni muhrlashidan saqlasin."
            }
        ];

        const HIKMATLAR = [
            "Qur'on o'qilgan xonadonga farishtalar tushadi.",
            "Sizlarning eng yaxshilaringiz Qur'onni o'rganib, o'rgatganlaringizdir.",
            "Qiyomat kuni Qur'on o'z sohibiga shafoatchi bo'ladi.",
            "Ilm oling, zero ilm saodat kalitidir.",
            "Oyatlar ustida tafakkur qilish â€” ulug' ibodatdir."
        ];

        // --- APP CONTROLLER ---
        const app = {
            state: {
                darkMode: false,
                difficulty: 'easy',
                mode: null, // 'juz' or 'full'
                questions: [],
                currentIdx: 0,
                score: 0,
                isAnswered: false,
                highScore: localStorage.getItem('quranHighScore') || 0
            },

            init: function() {
                this.renderJuzGrid();
                this.updateHighScoreUI();
                // Check theme preference
                if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    this.toggleTheme();
                }
            },

            toggleTheme: function() {
                this.state.darkMode = !this.state.darkMode;
                document.body.setAttribute('data-theme', this.state.darkMode ? 'dark' : 'light');
                document.getElementById('theme-btn').innerText = this.state.darkMode ? 'â˜€ï¸' : 'ğŸŒ™';
            },

            updateHighScoreUI: function() {
                document.getElementById('high-score-display').innerText = `Eng yaxshi natija: ${this.state.highScore}%`;
            },

            renderJuzGrid: function() {
                const grid = document.getElementById('juz-container');
                grid.innerHTML = '';
                for (let i = 1; i <= 30; i++) {
                    const btn = document.createElement('div');
                    btn.className = 'juz-btn';
                    btn.innerText = `${i}-JUZ`;
                    btn.onclick = () => this.startJuzTest(i);
                    grid.appendChild(btn);
                }
            },

            // Navigation Logic
            hideAll: function() {
                ['home-section', 'mode-section', 'quiz-section', 'result-section'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
            },

            goHome: function() {
                this.hideAll();
                document.getElementById('home-section').classList.remove('hidden');
            },

            showModeSelect: function() {
                this.hideAll();
                document.getElementById('mode-section').classList.remove('hidden');
                // Set default diff style
                this.setDifficulty(this.state.difficulty);
            },

            setDifficulty: function(level) {
                this.state.difficulty = level;
                // UI update
                ['easy', 'medium', 'hard'].forEach(d => {
                    const btn = document.getElementById(`diff-${d}`);
                    if (d === level) {
                        btn.className = 'btn btn-primary';
                    } else {
                        btn.className = 'btn btn-outline';
                    }
                });
            },

            // QUIZ LOGIC
            startJuzTest: function(juz) {
                // Filter questions
                let q = DB.filter(item => item.juz === juz && item.diff === this.state.difficulty);
                if(q.length === 0) {
                     // Fallback mechanism for demo (if specific logic missing, fetch general)
                     q = DB.filter(item => item.juz === juz); 
                     if(q.length === 0) {
                         alert(`Uzur, bu demo versiyada ${juz}-juz uchun savollar kiritilmagan. Iltimos 1, 29 yoki 30-juzni tanlang.`);
                         return;
                     }
                }
                this.prepareQuiz(q);
            },

            startFullTest: function() {
                // Get random mix
                let q = DB.sort(() => 0.5 - Math.random()).slice(0, 10);
                this.prepareQuiz(q);
            },

            prepareQuiz: function(questions) {
                this.state.questions = questions.sort(() => 0.5 - Math.random());
                this.state.currentIdx = 0;
                this.state.score = 0;
                this.state.isAnswered = false;
                
                this.hideAll();
                document.getElementById('quiz-section').classList.remove('hidden');
                this.renderQuestion();
            },

            renderQuestion: function() {
                const q = this.state.questions[this.state.currentIdx];
                const total = this.state.questions.length;
                
                // Update Progress
                const pct = ((this.state.currentIdx) / total) * 100;
                document.getElementById('quiz-progress').style.width = `${pct}%`;
                document.getElementById('q-counter').innerText = `${this.state.currentIdx + 1} / ${total}`;
                
                // Diff Label Translate
                const diffMap = { 'easy': 'Oson', 'medium': "O'rta", 'hard': 'Qiyin' };
                document.getElementById('q-diff-label').innerText = diffMap[q.diff] || 'Umumiy';

                // Content
                document.getElementById('q-instruction').innerText = q.q;
                document.getElementById('q-ayah-display').innerText = q.ayah;
                
                // Options Generation (Shuffle Logic)
                const list = document.getElementById('options-list');
                list.innerHTML = '';
                
                // Create indexed array to track correct answer after shuffle
                let opts = q.options.map((txt, idx) => ({ txt, originalIdx: idx }));
                opts.sort(() => Math.random() - 0.5);

                opts.forEach((opt) => {
                    const btn = document.createElement('div');
                    btn.className = 'option-card';
                    btn.innerText = opt.txt;
                    btn.onclick = () => this.handleAnswer(btn, opt.originalIdx, q.correct, q.hikmat);
                    list.appendChild(btn);
                });

                // Reset UI states
                document.getElementById('hikmat-box').style.display = 'none';
                document.getElementById('next-btn').classList.add('hidden');
                this.state.isAnswered = false;
            },

            handleAnswer: function(el, selectedIdx, correctIdx, customHikmat) {
                if(this.state.isAnswered) return;
                this.state.isAnswered = true;

                const allOpts = document.querySelectorAll('.option-card');
                
                if(selectedIdx === correctIdx) {
                    el.classList.add('correct');
                    this.state.score++;
                } else {
                    el.classList.add('wrong');
                    // Find and highlight correct one
                    // Note: In real app, better ID tracking needed. Here we assume text uniqueness or simplified logic
                    // Showing correct answer is crucial for learning.
                    // We need to find the DOM element that corresponds to correctIdx. 
                    // Since we shuffled, we can't just use index.
                    // Let's just highlight the one that wasn't clicked if it matches correct text?
                    // Simplified: We know the correct TEXT from DB.
                    const correctText = this.state.questions[this.state.currentIdx].options[correctIdx];
                    allOpts.forEach(opt => {
                        if(opt.innerText === correctText) opt.classList.add('correct');
                    });
                }

                // Show Hikmat
                const hText = customHikmat || HIKMATLAR[Math.floor(Math.random() * HIKMATLAR.length)];
                document.getElementById('hikmat-text').innerText = hText;
                document.getElementById('hikmat-box').style.display = 'block';

                // Next Button
                const nBtn = document.getElementById('next-btn');
                const isLast = this.state.currentIdx === this.state.questions.length - 1;
                nBtn.innerText = isLast ? "Natijani Ko'rish" : "Keyingi Savol";
                nBtn.classList.remove('hidden');
            },

            nextQuestion: function() {
                if(this.state.currentIdx < this.state.questions.length - 1) {
                    this.state.currentIdx++;
                    this.renderQuestion();
                } else {
                    this.finishQuiz();
                }
            },

            confirmExit: function() {
                if(confirm("Imtihonni to'xtatmoqchimisiz? Natijalar saqlanmaydi.")) {
                    this.goHome();
                }
            },

            finishQuiz: function() {
                this.hideAll();
                const total = this.state.questions.length;
                const score = this.state.score;
                const percent = Math.round((score / total) * 100);

                // Update High Score
                if(percent > this.state.highScore) {
                    this.state.highScore = percent;
                    localStorage.setItem('quranHighScore', percent);
                    this.updateHighScoreUI();
                }

                document.getElementById('result-section').classList.remove('hidden');
                
                // Update Circle
                const circle = document.getElementById('result-circle');
                circle.style.background = `conic-gradient(var(--primary) ${percent}%, rgba(0,0,0,0.1) ${percent}%)`;
                document.getElementById('result-percent').innerText = `${percent}%`;

                document.getElementById('res-correct').innerText = score;
                document.getElementById('res-wrong').innerText = total - score;

                // Feedback
                let msg = "";
                if(percent === 100) msg = "MashaAlloh! Mukammal natija. Siz hofizsiz!";
                else if(percent >= 80) msg = "Barakalla! Juda yaxshi, lekin ozgina takrorlash kerak.";
                else if(percent >= 50) msg = "Yaxshi. Muntazam takrorlashni kanda qilmang.";
                else msg = "Ko'proq harakat qiling. Alloh yo'lida charchamang!";
                
                document.getElementById('feedback-text').innerText = msg;
            }
        };

        // Ilovani ishga tushirish
        app.init();
    </script>
</body>
</html>
